# Quick guide

## Update app version, compile main app, compile all tests (including windows tests), all in one single command:

## Faster incremental builds, see docs\dev_docs\build_optimization_report.mddocs\dev_docs\build_optimization_report.md 
& 'C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\Tools\Launch-VsDevShell.ps1' -Arch amd64 -SkipAutomaticLocation; cmake -S . -B build; cmake --build build --config Release

## Complete clean new build, slower, only necessary in some cases, like project restructuring
& 'C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\Tools\Launch-VsDevShell.ps1' -Arch amd64 -SkipAutomaticLocation; cmake -S . -B build; cmake --build build --config Release --clean-first

## Run all tests, c++ and python:
python scripts/run_all_tests.py
# explanation:
# Set PYTHONPATH and run all python tests
# $env:PYTHONPATH="tools"; python -m pytest tests tools/lmuffb_log_analyzer/tests
# .\build\tests\Release\run_combined_tests.exe ; $env:PYTHONPATH="tools" ; python -m pytest tests tools/lmuffb_log_analyzer/tests
# python scripts/run_all_tests.py


## Run code Coverage (Linux)
## See documentation: docs/dev_docs/linux_test_coverage.md
# cmake -S . -B build -DBUILD_HEADLESS=ON -DENABLE_COVERAGE=ON
# cmake --build build
# ./build/tests/run_combined_tests
# lcov --capture --directory . --output-file coverage.info
# lcov --extract coverage.info "*/src/*" --output-file coverage_filtered.info
# genhtml coverage_filtered.info --output-directory coverage_report

TODO:
Done: add documentation to include code coverage on linux for this project.
Run it everytime with tests on linux, and check that all new code has 99%+ coverage.
Done: Add instructions (eg. fixer.md) stating that if coverage of new features is not 99%+ we should iterate and add more tests.
See:  https://blog.cihar.com/archives/2016/08/26/ci-coverage-windows-linux-and-osx/
"
On Linux and OSX it was pretty much straightforward. Both GCC and Clang do support coverage, so it's just matter of configuring them properly and collect the coverage reports. I've used own solution for that in past and that was really far from working well (somehow I never managed to get coverage fully uploaded to Codecov). Fortunately there exists CMake script called CMake-codecov which does all needed work and works out of the box on GCC and Clang (even on OSX). Well it works on Travis only once you update the compilers and install llvm-cov tool."
Done: compilation of tests is faster now (less optimized on all platforms).


---

# Enabling clang-tidy Locally on Windows
# 1. Setup Environment, Add Clang-Tidy to Path, Configure CMake with Ninja, and Build (all in one go)
# (Running `Launch-VsDevShell.ps1` prevents issues where CMake accidentally picks up MSYS64 or MinGW compilers instead of MSVC, which causes 'cmath' missing errors)
# Note: We use a separate 'build_ninja' folder to avoid conflicts with your existing Visual Studio build folder
& 'C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\Tools\Launch-VsDevShell.ps1' -Arch amd64 -SkipAutomaticLocation; $env:PATH += ";C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Tools\Llvm\x64\bin"; cmake -S . -B build_ninja -G Ninja -DCMAKE_BUILD_TYPE=Debug -DBUILD_HEADLESS=ON -DCMAKE_CXX_CLANG_TIDY="clang-tidy;-checks=-*,performance-*,bugprone-*,readability-*,-readability-magic-numbers,-readability-uppercase-literal-suffix,-readability-implicit-bool-conversion,-readability-avoid-nested-conditional-operator,-readability-braces-around-statements,-performance-avoid-endl,-readability-function-cognitive-complexity,-bugprone-easily-swappable-parameters,-readability-identifier-length,-readability-isolate-declaration,-readability-convert-member-functions-to-static,-readability-make-member-function-const,-readability-container-size-empty,-readability-else-after-return,-bugprone-narrowing-conversions,-readability-redundant-string-init,-bugprone-integer-division,-bugprone-exception-escape,-performance-inefficient-string-concatenation,-performance-no-int-to-ptr,-readability-inconsistent-declaration-parameter-name,-bugprone-branch-clone,-bugprone-implicit-widening-of-multiplication-result,-performance-unnecessary-value-param,-bugprone-incorrect-roundings,-bugprone-empty-catch,-readability-qualified-auto,-readability-redundant-string-cstr,-readability-static-accessed-through-instance,-bugprone-unchecked-optional-access,-performance-type-promotion-in-math-fn,-readability-redundant-casting;--extra-arg=/EHsc"; cmake --build build_ninja --config Debug --clean-first



-----

# Install ImGui
## Dear ImGui (Optional): Download from GitHub and place in vendor/imgui to enable the GUI.

New-Item -ItemType Directory -Path "vendor\imgui" -Force
Invoke-WebRequest -Uri "https://github.com/ocornut/imgui/archive/refs/heads/master.zip" -OutFile "vendor\imgui-master.zip"
Expand-Archive -Path "vendor\imgui-master.zip" -DestinationPath "vendor" -Force
Copy-Item -Path "vendor\imgui-master\*" -Destination "vendor\imgui\" -Recurse -Force
Test-Path "vendor\imgui\imgui.cpp"
Remove-Item -Path "vendor\imgui-master.zip", "vendor\imgui-master" -Recurse -Force


----

## Run all c++ tests that had already been compiled:
.\build\tests\Release\run_combined_tests.exe



# Compile and run tests, including windows platform-specific tests

& 'C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\Tools\Launch-VsDevShell.ps1' -Arch amd64 -SkipAutomaticLocation; `
cl /EHsc /std:c++17 /I.. /D_CRT_SECURE_NO_WARNINGS tests\test_ffb_engine.cpp src\Config.cpp /Fe:tests\test_ffb_engine.exe; `
tests\test_ffb_engine.exe; `
# Note: For windows platform tests involving GUI, using CMake is highly recommended:
# cmake -S . -B build; cmake --build build --config Release --target run_tests_win32; .\build\tests\Release\run_tests_win32.exe
cl /EHsc /std:c++17 /I.. /Ivendor\imgui /Ivendor\imgui\backends /DUNICODE /D_UNICODE /D_CRT_SECURE_NO_WARNINGS /DENABLE_IMGUI tests\test_windows_platform.cpp src\DirectInputFFB.cpp src\Config.cpp src\GuiLayer.cpp src\GameConnector.cpp vendor\imgui\imgui.cpp vendor\imgui\imgui_draw.cpp vendor\imgui\imgui_widgets.cpp vendor\imgui\imgui_tables.cpp vendor\imgui\imgui_demo.cpp vendor\imgui\backends\imgui_impl_win32.cpp vendor\imgui\backends\imgui_impl_dx11.cpp dinput8.lib dxguid.lib winmm.lib version.lib imm32.lib user32.lib ole32.lib d3d11.lib dxgi.lib /Fe:tests\test_windows_platform.exe; `
tests\test_windows_platform.exe


# Compile and save output to a utf8 txt file

& 'C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\Tools\Launch-VsDevShell.ps1' -Arch amd64 -SkipAutomaticLocation; cmake --build build --config Release --clean-first | Out-File -FilePath "build_log.txt" -Encoding UTF8

# Prerequisites

Enable run scripts in powershell:
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser


Write build files (windows)
& 'C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\Tools\Launch-VsDevShell.ps1' -Arch amd64 -SkipAutomaticLocation; cmake -B build


& 'C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\Tools\Launch-VsDevShell.ps1' -Arch amd64 -SkipAutomaticLocation; cmake -B build

# Actual build

Update version number
& 'C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\Tools\Launch-VsDevShell.ps1' -Arch amd64 -SkipAutomaticLocation; cmake -S . -B build

Build release (Windows)
& 'C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\Tools\Launch-VsDevShell.ps1' -Arch amd64 -SkipAutomaticLocation; cmake --build build --config Release

Clean re-build release (Windows)
& 'C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\Tools\Launch-VsDevShell.ps1' -Arch amd64 -SkipAutomaticLocation; cmake --build build --config Release --clean-first

Update version and clean re-build (Windows)
& 'C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\Tools\Launch-VsDevShell.ps1' -Arch amd64 -SkipAutomaticLocation; cmake -S . -B build; cmake --build build --config Release --clean-first




To run the tests:

First compile the test directly:

& 'C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\Tools\Launch-VsDevShell.ps1' -Arch amd64 -SkipAutomaticLocation; cl /EHsc /std:c++17 /I.. tests\test_ffb_engine.cpp src\Config.cpp /Fe:tests\test_ffb_engine.exe


Then run it (choose one option):

# Option 1: Display on console AND save to file (RECOMMENDED)
tests\test_ffb_engine.exe 2>&1 | Tee-Object -FilePath tmp\test_results.txt

# Option 2: Only display on console (may truncate if output is long)
tests\test_ffb_engine.exe

# Option 3: Only save to file (no console output)
tests\test_ffb_engine.exe > tmp\test_results.txt 2>&1
Get-Content tmp\test_results.txt

# Option 4: Just show the summary
tests\test_ffb_engine.exe 2>&1 | Select-String -Pattern "Tests (Passed|Failed):"