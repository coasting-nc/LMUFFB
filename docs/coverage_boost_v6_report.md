# Code Coverage Boost V6 - Strategy and Results

This patch (v0.7.84) focuses on expanding the test suite to cover missing branches and edge cases in the LMUFFB project, particularly in the mocking layer, application entry point, and shared memory interface.

## Strategies for Increasing Coverage

1.  **Fault Injection in Mocks:**
    Extended `LinuxMock.h` with a `FailNext()` mechanism. This allows unit tests to simulate Win32 API failures (e.g., `CreateFileMappingA` returning `NULL`) without requiring a specialized kernel environment. This was used to cover error-handling branches in `GameConnector` and `SafeSharedMemoryLock`.

2.  **Threaded Contention Simulation:**
    To test the `SharedMemoryLock` spin-lock and timeout logic, a dedicated thread was used to "kidnap" the lock, forcing the main test thread to exercise the wait-and-timeout branches.

3.  **INI Key Exhaustion:**
    Created a "mega-INI" for `Config::Load` tests that includes every known key, legacy keys (triggering migration logic), and invalid keys. This significantly improved coverage in the large `if/else if` blocks of `ParsePresetLine`.

4.  **UI State Permutation:**
    Used the `GuiLayerTestAccess` pattern to call private UI drawing functions with an `FFBEngine` instance in various states (e.g., toggling Soft Lock, Slope Detection, different Torque Sources). This triggers conditional rendering branches in `GuiLayer_Common.cpp`.

5.  **Telemetry Data Generation:**
    Implemented a "telemetry producer" thread in tests to feed `FFBThread` with dynamic data. This was used to trigger:
    *   `ChannelMonitor::Update` branches for all 20+ telemetry channels.
    *   Menu transition logic ("User entered driving session" / "User exited to menu").
    *   Health warning logic (by running the producer slower than 400Hz).

## Key Improvements

| File | Type | Improvement |
| :--- | :--- | :--- |
| `LinuxMock.h` | Branch | 69.4% â†’ 74.3% |
| `GameConnector.cpp` | Line | 89.1% â†’ 94.6% |
| `GameConnector.cpp` | Branch | 55.9% â†’ 60.8% |
| `GripLoadEstimation.cpp` | Branch | 74.7% â†’ 76.8% |
| `main.cpp` | Branch | 25.0% â†’ 27.0% |

## Challenges and Constraints

*   **Platform Specificity:** A significant number of missing branches in `main.cpp` and `DirectInputFFB.cpp` are related to Win32-specific APIs (DirectInput, `timeBeginPeriod`) or Windows message loops. These cannot be covered in the Linux-based CI environment despite extensive mocking.
*   **ImGui Branch Density:** `GuiLayer_Common.cpp` contains hundreds of branches generated by ImGui macros. While the logic is exercised, the sheer density of UI-related branches makes reaching 90%+ branch coverage impractical for a functional test suite.
*   **Safety vs. Coverage:** Some branches in `FFBEngine` are "impossible" safety checks (e.g., divide-by-zero protection with epsilons). While these can be triggered with `NaN` or `Inf` inputs, doing so requires careful state management to avoid crashing the test runner.

## Discrepancies with Code Review

The first code review (Iteration 1) correctly pointed out that the patch included many auto-generated test artifacts (.csv, .ini, summary.json). I have since implemented a more robust cleanup logic in `main_test_runner.cpp` and manually deleted all existing artifacts before the final submission. The reports and summaries are now updated and the repository is clean.

## Conclusion

The general code coverage has been improved, especially in critical system-level components. The addition of `test_coverage_boost_v6.cpp` provides a robust foundation for testing system integration and error recovery logic.
