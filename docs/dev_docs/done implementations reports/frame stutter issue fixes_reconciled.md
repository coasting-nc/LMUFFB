# Frame Stutter & Physics Stability Fixes (Reconciled Report)

### 1. Overview
This report reconciles findings from previous investigations into "Frame Stutter" issues and "Phase Explosion" bugs. It documents the final implemented fixes ensuring the FFB engine remains stable during variable frame rates (e.g., game freezes, low FPS) and prevents physics explosions due to invalid configuration.

### 2. Addressed Issues

#### A. Phase Explosion (Oscillators)
*   **Issue:** Oscillators for Lockup, Spin, Slide, and Bottoming accumulated phase using `phase += freq * dt * 2PI`. If `dt` became very large (stutter), the phase could increment by huge values, causing precision loss or excessive wrapping logic if implemented naively.
*   **Fix:** All oscillators now use `std::fmod(phase, TWO_PI)` to safely wrap the phase within `[0, 2Ï€]`. This ensures mathematical stability regardless of the time step size.
*   **Status:** **FIXED** (Verified in regression tests).

#### B. Time Dilation (Smoothing Filters)
*   **Issue:** Several Low Pass Filters (LPF) used a fixed alpha (e.g., `0.1`). This coefficient represents a specific smoothing factor *only* at the target frame rate (400Hz).
    *   At 400Hz (2.5ms), `alpha=0.1` provides good smoothing.
    *   At 50Hz (20ms) or during a stutter (e.g., 100ms), `alpha=0.1` is effectively 8-40x slower/weaker, causing FFB to lag significantly behind physics.
*   **Fix:** Implementation of **Time-Corrected Alpha** across all filters.
    *   Formula: `alpha = dt / (tau + dt)`
    *   Where `tau` (time constant) is set to `0.0225` (approx matching the legacy 0.1@400Hz feel).
    *   This ensures the filter response time (convergence speed) is consistent in *real-time*, regardless of frame rate.
*   **Affected Areas:**
    1.  **Slip Angle Smoothing:** (`calculate_slip_angle`)
    2.  **Yaw Acceleration Smoothing:** (`calculate_force`)
    3.  **Gyroscopic Damping:** (`calculate_force`) - Now derived from `m_gyro_smoothing`.

#### C. Gyro Stability Risk
*   **Issue:** The `m_gyro_smoothing` parameter was read directly from config without clamping. A negative value could invert the LPF logic, leading to exponential growth (explosion) of steering velocity values.
*   **Fix:** Added clamping: `m_gyro_smoothing = clamp(0.0, 0.99, value)`. This prevents unstable filter coefficients.

### 3. Implementation Details

#### Updated Signal Flow
*   `calculate_force` now propagates `dt` (Delta Time) into helper functions like `calculate_grip` and `calculate_slip_angle` to ensure physics calculations are time-aware.
*   **Slip Angle LPF:** `alpha = dt / (0.0225 + dt)`
*   **Yaw Accel LPF:** `alpha = dt / (0.0225 + dt)`
*   **Gyro LPF:** `tau = smoothness * 0.1`; `alpha = dt / (tau + dt)`

### 4. Verification & Testing
New regression tests have been added to `tests/test_ffb_engine.cpp`:
1.  **`test_regression_phase_explosion`**: Simulates a 50ms stutter and verifies that Slide, Lockup, and Spin phases remain within valid bounds.
2.  **`test_time_corrected_smoothing`**: Compares filter output at 400Hz vs 50Hz to ensure consistent behavior.
3.  **`test_gyro_stability`**: Injects invalid (negative) smoothing values to verify safety clamps.

All tests passed successfully (127/127).

---
*Report generated by Antigravity Agent on 2025-12-20.*
