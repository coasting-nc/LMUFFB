# Implementation Plan - Accuracy Tools (Surface Type & Phase Analysis)

## 1. Context
Following the stabilization of the Slope Detection algorithm (Plan: [Slope Fix](./Slope%20Detection%20Fixes%20&%20Telemetry%20Enhancements%20v0.7.35.md)), this phase focuses on **Accuracy** and **Tuning**. To perfectly tune the Slope Detection window (`m_slope_sg_window`), we need to measure the physical phase lag between steering input and tire force generation. Additionally, to prevent false positives in the analysis, we must be able to filter out data generated by non-flat surfaces (curbs, grass, rumble strips).

**Goal:**
1.  **Contextual Logging:** Add `SurfaceType` to the telemetry log to allow filtering of noisy data (curb strikes).
2.  **Phase Analysis:** Define the specification for a Cross-Correlation tool in the Log Analyzer to measure tire relaxation lag and recommend optimal window settings.

**Reference Documents:**
*   Previous Plan: `docs/dev_docs/implementation_plans/Slope Detection Fixes & Telemetry Enhancements v0.7.35.md`
*   Diagnostic Reports: `results_mclaren_pr.zip` (High noise noted)

## 2. Codebase Analysis

### 2.1 Architecture Overview
*   **Telemetry Data (`src/lmu_sm_interface/InternalsPlugin.hpp`):** The `TelemWheelV01` struct contains `unsigned char mSurfaceType` (0=dry, 1=wet, 5=rumblestrip, etc.).
*   **Physics Engine (`src/FFBEngine.h`):** The `calculate_force` method has access to the full `TelemInfoV01` structure.
*   **Logger (`src/AsyncLogger.h`):** Currently logs float values. Needs to be expanded to log integer surface codes.

### 2.2 Impacted Functionalities
*   **Logging Pipeline:** The `LogFrame` struct size will increase slightly.
*   **Log Analysis:** The external analyzer tool will need to parse the new columns.

## 3. FFB Effect Impact Analysis

| Effect | Technical Impact | User Perspective |
| :--- | :--- | :--- |
| **None (Direct)** | No changes to FFB generation logic. | No immediate change in feel. |
| **Slope Detection (Indirect)** | Provides data to tune `m_slope_sg_window`. | Future tuning based on this data will result in tighter, more responsive understeer cues. |

## 4. Proposed Changes

### 4.1 File: `src/AsyncLogger.h`

**A. Update `LogFrame` Struct**
Add fields for surface types. We log both front wheels as they often differ (e.g., one wheel on a curb).
```cpp
struct LogFrame {
    // ... existing fields ...
    float surface_type_fl; // Cast to float for CSV uniformity, or keep int if formatter supports it
    float surface_type_fr;
    // ...
};
```

**B. Update `WriteHeader`**
Add columns: `SurfaceFL,SurfaceFR`.

**C. Update `WriteFrame`**
Output the new fields.

### 4.2 File: `src/FFBEngine.h`

**A. Update `calculate_force`**
Extract surface data from telemetry and populate the log frame.
```cpp
// Inside logging block
frame.surface_type_fl = (float)data->mWheel[0].mSurfaceType;
frame.surface_type_fr = (float)data->mWheel[1].mSurfaceType;
```

### 4.3 Documentation: `docs/dev_docs/log_analyzer_v2.md`

**A. Create Specification for Cross-Correlation**
Since the Log Analyzer code is external, create a detailed technical specification for the "Phase Lag Analysis" feature.
*   **Input:** `dAlpha_dt` (Steering Rate) and `dG_dt` (Lateral G Rate).
*   **Algorithm:**
    1.  Filter data: Exclude frames where `SurfaceType != 0` (Asphalt) or `Speed < 10m/s`.
    2.  Normalize signals (Z-score).
    3.  Compute Cross-Correlation $R(\tau)$ for lags $\tau = 0$ to $100ms$.
    4.  Find $\tau_{peak}$ where $R(\tau)$ is max.
*   **Output:**
    *   "Measured Physical Lag: X ms"
    *   "Recommended Window Size: N samples" (where $N = \tau_{peak} / dt$).

### 4.4 File: `VERSION` & `src/Version.h`
*   Increment version (e.g., `0.7.36` -> `0.7.37`).

## 5. Test Plan (TDD)

**New Test File:** `tests/test_ffb_accuracy_tools.cpp`

### Test 1: `test_surface_type_logging`
*   **Goal:** Verify surface types are correctly captured and logged.
*   **Setup:**
    *   Initialize Engine and Logger.
    *   Create mock telemetry.
    *   Set `mWheel[0].mSurfaceType = 5` (Rumblestrip).
    *   Set `mWheel[1].mSurfaceType = 0` (Dry).
*   **Action:** Run `calculate_force` (triggering log).
*   **Assertion:**
    *   Read the generated CSV line.
    *   Verify column `SurfaceFL` is `5.0`.
    *   Verify column `SurfaceFR` is `0.0`.

### Test 2: `test_surface_type_filtering_logic` (Unit Test for Spec)
*   **Goal:** Verify the logic intended for the analyzer (filtering bad data).
*   **Setup:**
    *   Create a dataset with mixed surface types.
    *   Implement a simple filter function (mimicking the analyzer spec).
*   **Assertion:** Ensure frames with `SurfaceType != 0` are excluded from the "clean" dataset used for correlation.

## 6. Deliverables

*   [ ] **Code:** Updated `src/AsyncLogger.h` (New columns).
*   [ ] **Code:** Updated `src/FFBEngine.h` (Data extraction).
*   [ ] **Docs:** New `docs/dev_docs/log_analyzer_v2.md` (Cross-Correlation Spec).
*   [ ] **Tests:** New `tests/test_ffb_accuracy_tools.cpp`.
*   [ ] **Implementation Notes:** Update plan with any CSV formatting issues encountered.

```json
{
  "status": "success",
  "plan_path": "docs/dev_docs/implementation_plans/Slope Detection Accuracy Tools.md",
  "backlog_items": []
}
```