# Bug report

An user reported the following issue. He tested the version after the Yaw Kick was introduced (while  Gyroscopic Damping is not implemented yet). Please help me diagnose the issue and what might be done to fix it.

User report:
"I just tested it and got it to work. FFB seems stronger especially on oversteer. The only thing that is broken for me is the slide rumble, which throws the wheel in the direction I am turning, regardless of the level. Coincidentally this might be the effect that I need to feel vibrations on understeer, if I am not mistaken?"

# Answer

### Diagnosis: The "Noise Feedback Loop"

Based on the user's report, the issue is likely **not** the Slide Rumble itself, but how the new **Yaw Kick** interacts with it.

**The Mechanism of Failure:**
1.  **Slide Rumble** injects a high-frequency vibration (Sawtooth wave) into the steering wheel.
2.  This vibration causes the virtual car's steering to jitter slightly (or the chassis to vibrate in the physics engine).
3.  **Yaw Acceleration (`mLocalRotAccel.y`)** is a *derivative* value. Derivatives are extremely sensitive to high-frequency noise. The vibration from the Slide Rumble causes massive, noisy spikes in the Yaw Acceleration telemetry.
4.  The new **Yaw Kick** feature reads these spikes and injects them back into the wheel as strong forces.
5.  **Result:** A positive feedback loop. The wheel shakes -> Telemetry spikes -> Yaw Kick throws the wheel -> Wheel shakes harder. This feels like the wheel is being "thrown" or fighting the user violently.

**Why it feels like "Slide Rumble" is broken:**
The user turns on Slide Rumble, and the wheel goes crazy. Naturally, they blame the Slide Rumble. However, the *root cause* is that the **Yaw Kick is amplifying the noise** generated by the rumble.

---

### Proposed Fix: Smooth the Yaw Acceleration

To fix this, we must apply a **Low Pass Filter (Smoothing)** to the Yaw Acceleration data before using it for the FFB. This filters out the high-frequency "noise" (vibrations) while keeping the low-frequency "signal" (the actual car rotation kick).

**Action Plan:**

1.  **Modify `FFBEngine.h`**:
    *   Add a state variable: `double m_yaw_accel_smoothed = 0.0;`
    *   Add a smoothing constant (or reuse `m_sop_smoothing_factor`, but a dedicated one is safer for this specific derivative). Let's use a fixed fast alpha (e.g., 0.1) or expose it.
    *   Update the calculation logic.

**Code Change:**

```cpp
// In FFBEngine.h

// 1. Add state variable
double m_yaw_accel_smoothed = 0.0;

// 2. In calculate_force()
// ...
double raw_yaw_accel = data->mLocalRotAccel.y;

// Apply Smoothing (Low Pass Filter)
// Alpha 0.1 means we trust 10% new data, 90% history. 
// This kills high-frequency vibration noise.
double alpha_yaw = 0.1; 
m_yaw_accel_smoothed = m_yaw_accel_smoothed + alpha_yaw * (raw_yaw_accel - m_yaw_accel_smoothed);

// Use SMOOTHED value for the kick
double yaw_force = m_yaw_accel_smoothed * m_sop_yaw_gain * 5.0; 

sop_total += yaw_force;
```

### Instructions for the User (Temporary Workaround)

You can advise the user to try this while waiting for the fix:
*"It seems the new Yaw Kick effect is reacting to the vibrations from the Slide Rumble. Please try **reducing the 'SoP Yaw (Kick)' slider** to a very low value (e.g., 0.1 or 0.0) and see if the Slide Rumble behaves normally again. We will add smoothing in the next update to prevent this interference."*

### Instructions for the Coding Agent

You should include this fix in the next prompt.

**Task Addition:**
*   **Context:** Users report instability when Slide Rumble and Yaw Kick are both active. The Yaw Acceleration telemetry is too noisy.
*   **Requirement:** Implement an **Exponential Moving Average (LPF)** for `mLocalRotAccel.y` inside `FFBEngine`. Use a hardcoded alpha of `0.1` (or link it to `m_sop_smoothing_factor`) before calculating `yaw_force`.